- name: Recover the versions of OpenShift published
  shell: >-
    podman search
    --limit 9999
    --authfile '{{ ansible_env["HOME"] }}/.docker/config.json'
    --list-tags
    {{ registry_hostname }}/{{ toplevel_namespace }}/openshift/release
    | tail -n+2
    | awk '{print $2}'
    | cut -d- -f1
    | sort -Vu
  register: mirrored_versions
  changed_when: false

- name: Extract the clients from the latest mirror
  shell: |-
    function extract_binary {
      binary=${1:?binary name is required}
      image=${2:? image name is required}
      podman run --replace --rm --name extract -d --entrypoint bash {{ registry_hostname }}/{{ toplevel_namespace }}/openshift/release:{{ mirrored_versions.stdout_lines|last }}-x86_64-$image -c 'while : ; do sleep 30; done'
      podman cp "extract:/usr/bin/$binary" "{{ ansible_env["HOME"] }}/bin/$binary" || exit 1
      sync
      podman stop extract
    }
    extract_binary oc cli
    extract_binary openshift-install installer
